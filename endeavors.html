<html lang="ru">

<head>
  <style>
    .selected {
      color:rgb(130, 3, 221)
    }

    table {
      border-spacing: 17px 3px;
    }
  </style>
</head>

<body>
  <div>
    <div>
      <a href="/">ToDo</a>
    </div>
    <input id=newEnd />
    <input id="deadline" type="date">
    <div><textarea id="detail" cols="30" rows="10"></textarea></div>
    <button id=create>Создать Стремление</button>
  </div>
  Мои Стремления:
  <table>
    <thead>
      <tr>
        <th>Название</th>
        <th>Детали</th>
        <th>Дедлайн</th>
      </tr>
    </thead>
    <tbody id=endvrs>
    </tbody>
  </table>
  <script>
    // загрузка стремлений
    fetch(location.origin + "/api/endeavor/get")
      .then(response => response.json()).then(arr =>
        endvrs.innerHTML += arr.reduce((html, doc) =>
          html +`<tr id="${doc._id}">
            <td>${doc.name}</td>
            <td>${doc.details}</td>
            <td>${doc.deadline}</td>
          </tr>`, ""
        )
      )
    // создание стремлений 
    create.onclick = function () {
      if (!newEnd.value.trim()) return

      newEnd.value = newEnd.value.trim()
      var promise = fetch(location.origin + "/api/endeavor/add", {
        headers: {
          endeavor: encodeURI(newEnd.value),
          details: encodeURI(detail.value),
          deadline: deadline.value
        }
      })
      promise.then(response => response.text()).then(text => {
        endvrs.innerHTML = endvrs.innerHTML + `<tr id="${text}">
        <td>${newEnd.value}</td>
        <td>${detail.value}</td>
        <td>${deadline.value}</td>
      </tr>`
      })
    }
    // выделение стремления для редактирования || удаления
    endvrs.onclick = function (event) {
      // сделать иф а не тру кетч
      try { endvrs.querySelector(".selected").classList.remove("selected") }
      catch {}
      event.target.parentElement.classList.add("selected")
    }
    document.body.onkeydown = function (event) {
      var target = endvrs.querySelector(".selected")
      if (target) {
        // обновление (update) стремление

        // удаление стремление
        if (event.key == "Delete") {
          target.remove()
          fetch(location.origin + "/api/endeavor/delete", 
            {headers: {id: target.id}})

        }
      }
    }
  </script>
</body>