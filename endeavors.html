<html lang="ru">

<head>
  <style>
    .selected {
      color:rgb(130, 3, 221)
    }
    table {
      border-spacing: 17px 3px;
    }
    .hidden {
      display: none
    }
  </style>
</head>

<body>
  <div>
    <div>
      <a href="/">ToDo</a>
    </div>
    <input id=nameEnds />
    <input id="deadline" type="date">
    <div><textarea id="detail" cols="30" rows="10"></textarea></div>
    <button id=create>Создать Стремление</button>
    <button id=save class=hidden>Сохранить Изменения</button>
  </div>
  Мои Стремления:
  <table>
    <thead>
      <tr>
        <th>Название</th>
        <th>Детали</th>
        <th>Дедлайн</th>
      </tr>
    </thead>
    <tbody id=endvrs>
    </tbody>
  </table>
  <script>
    // загрузка стремлений
    fetch(location.origin + "/api/endeavor/get")
      .then(response => response.json()).then(arr =>
        endvrs.innerHTML += arr.reduce((html, doc) =>
          html +`<tr id="${doc._id}">
            <td>${doc.name}</td>
            <td>${doc.details}</td>
            <td>${doc.deadline}</td>
          </tr>`, ""
        )
      )
    // создание стремлений 
    create.onclick = function () {
      if (!nameEnds.value.trim()) return

      nameEnds.value = nameEnds.value.trim()
      var promise = fetch(location.origin + "/api/endeavor/add", {
        headers: {
          endeavor: encodeURI(nameEnds.value),
          details: encodeURI(detail.value),
          deadline: deadline.value
        }
      })
      promise.then(response => response.text()).then(text => {
        endvrs.innerHTML = endvrs.innerHTML + `<tr id="${text}">
        <td>${nameEnds.value}</td>
        <td>${detail.value}</td>
        <td>${deadline.value}</td>
      </tr>`
      })
    }
    // выделение стремления для редактирования || удаления
    endvrs.onclick = function (event) {
      // сделать иф а не тру кетч
      try { endvrs.querySelector(".selected").classList.remove("selected") }
      catch {}
      event.target.parentElement.classList.add("selected")
    }

    endvrs.ondblclick = function (event) {
      var target = event.target.parentElement
      // cделать функцию редактирования стремления
    }
    document.body.onkeydown = function (event) {
      var target = endvrs.querySelector(".selected")
      if (target) {
        // обновление (update) стремление
        if (event.key == "F2") {
          nameEnds.value = target.children[0].innerText
          detail.value = target.children[1].innerText
          deadline.value = target.children[2].innerText
          save.classList.remove("hidden")
          // убрать кнопку "создать Стр"
          save.onclick = function () {
            nameEnds.value = nameEnds.value.trim()
            fetch(location.origin + "/api/endeavor/update", {
              headers: {
                id: target.id,
                endeavor: encodeURI(nameEnds.value),
                details: encodeURI(detail.value),
                deadline: deadline.value
              }
            }).then(response=> response.json())
              .then(status=> { if (status.success) {
                  target.children[0].innerText = nameEnds.value
                  target.children[1].innerText = detail.value
                  target.children[2].innerText = deadline.value
                  nameEnds.value = detail.value = deadline.value = ""
                  save.classList.add("hidden")
              }})
          }
        }
        // удаление стремление
        if (event.key == "Delete") {
          fetch(location.origin + "/api/endeavor/delete", 
            {headers: {id: target.id}}).then(response=> response.json())
              .then(status=> {if (status.success) target.remove()})
          
        }
      }
    }
    
  </script>
</body>