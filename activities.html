<html lang="ru">

<head>
  <style>
    .selected {
      color: rgb(130, 3, 221)
    }

    table {
      border-spacing: 17px 3px;
    }

    .hidden {
      display: none
    }
  </style>
</head>

<body>
  <div>
    <div>
      <a href="/">ToDo</a>
      <a href="/endeavors">Endeavors</a>

    </div>
    <input id=activity>
    <input id=measure>
    <select id=diff>
      <script>
        for (i=1; i<11; ++i) diff.innerHTML += `<option value=${i}>${i}` 
        diff.value="5"
      </script>
    </select>
    <button id=create>Создать Действие</button>
    <button id=save class=hidden>Сохранить Изменения</button>
  </div>
  Мои Действия:
  <table>
    <thead>
      <tr>
        <th>Название</th>
        <th>Мера</th>
        <th>Сложность</th>
      </tr>
    </thead>
    <tbody id=acts>
    </tbody>
  </table>
  <script>
    // загрузка стремлений
    api2("activity", "get", {}, arr => acts.innerHTML += 
      arr.reduce((html, doc) => html + tr(...Object.values(doc)), ""))

    // создание действий 
    create.onclick = function () {
      if (!activity.value.trim() || !measure.value.trim()) return

      activity.value = activity.value.trim()

      const pkg = {name: activity.value, measure: measure.value,
                    diff: diff.value}

      api2("activity", "add", pkg, answer => acts.innerHTML = 
        acts.innerHTML + tr(answer.id, ...Object.values(pkg)))
    }
    // выделение стремления для редактирования || удаления
    acts.onclick = function (event) {
      const prev = acts.querySelector(".selected")
      if (prev) prev.classList.remove("selected")
      if (event.target != acts)
        event.target.parentElement.classList.add("selected")
    }

    acts.ondblclick = function (event) {
      var target = event.target.parentElement
      updateEndeavors(target)
    }

    document.body.onkeydown = function (event) {
      var target = acts.querySelector(".selected")
      if (target) {
        // обновление (update) стремление
        if (event.key == "F2") updateEndeavors(target)
        // удаление стремление
        if (event.key == "Delete") 
          api2("activity", "delete", {id: target.id}, 
            status => { if (status.success) target.remove() })
      }
    }

    // Декларация Функций

    // Функция редактирования Стремления
    function updateEndeavors(target) {
      activity.value = target.children[0].innerText
      measure.value = target.children[1].innerText
      diff.value = target.children[2].innerText

      save.classList.remove("hidden")
      create.disabled = true
      save.onclick = function () {
        activity.value = activity.value.trim()

        const pkg = {id: target.id, name: activity.value, 
          measure: measure.value, diff: diff.value}

        api2("activity", "update", pkg, status => {
          if (status.success) {
            target.outerHTML = tr(...Object.values(pkg))
            activity.value = measure.value = diff.value = ""
            save.classList.add("hidden")
            create.disabled = false
          }
        })
      }
    }
    // Ф-ия Отправка и обработка запроса
    function api2(routePart1, routePart2, pkg, callback) {
      fetch("/api/"+routePart1+"/"+routePart2, {
        headers: {pkg: encodeURI(JSON.stringify(pkg))}
      }).then(response => response.json()).then(callback)
    }
    // Ф-ия разметка ряда таблицы
    function tr(id, name, measure, diff) {
      return `<tr id="${id}"><td>${name}</td><td>${measure}</td>
              <td>${diff}</td></tr>`
    }
  </script>
</body>